name: Lint/Publish Ansible Collection

on:
  workflow_call:

jobs:
  publish_checks:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v5
      - run: pipx install poetry
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'poetry'
      - run: poetry install
      - run: echo "$(poetry env info --path)/bin" >> $GITHUB_PATH
      - name: Parse bws-cache version
        id: bws_cache_version
        run: |
          echo "::set-output name=result::$(python3 src/meshmon/version.py)"
      - name: Parse git tag
        id: git_tag
        run: |
          echo "::set-output name=result::${GITHUB_REF#refs/tags/v}"
      - name: Assert bws-cache version matches tag
        run: |
          if [[ "${{ steps.bws_cache_version.outputs.result }}" != "${{ steps.git_tag.outputs.result }}" ]]; then
            line=$(grep -no '^version:\s\d.*$' src/meshmon/version.py | cut -d: -f1)
            echo "::error file=src/meshmon/version.py,line=${line}::Version in src/meshmon/version.py does not match tag"
            echo "❌ Version in src/meshmon/version.py does not match git tag" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ Version in src/meshmon/version.py matches git tag" >> $GITHUB_STEP_SUMMARY
          fi

